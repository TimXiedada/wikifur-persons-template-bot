name: Generate Config File

on:
  schedule:
    # 北京时间每天7点，对应UTC时间23点 (7-8=-1 => 23 UTC)
    - cron: '0 23 * * *'
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-config:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create config.ini from environment variables
      run: |
        echo "[Location]" > config.ini
        echo "; 专用工具是这样的" >> config.ini
        echo "domain=${{ secrets.WIKIFUR_DOMAIN }}" >> config.ini
        echo "" >> config.ini
        echo "[Credential]" >> config.ini
        echo "; 该部分为敏感信息，严禁纳入版本控制！" >> config.ini
        echo "; This section is considered confidential, DO NOT commit in VCS!" >> config.ini
        echo "username=${{ secrets.WIKIFUR_USERNAME }}" >> config.ini
        echo "password=${{ secrets.WIKIFUR_PASSWORD }}" >> config.ini
        
    - name: Configure git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: Commit and push config.ini
      run: |
        git add config.ini
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto-generate config.ini from secrets"
          git push
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}